rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Groups - only owner can modify
      match /groups/{groupId} {
        // Allow read if user is the owner (check both resource and userId context)
        allow read: if request.auth != null && 
          (request.auth.uid == userId || 
           request.auth.uid == resource.data.ownerId ||
           !resource.exists);
        allow create: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == request.resource.data.ownerId;
        allow update: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == resource.data.ownerId;
        allow delete: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == resource.data.ownerId;

        // Events - owner can do everything, guests have limited access
        match /events/{eventId} {
          // Read: owner or guest (simplified check - detailed checks in app code)
          allow read: if request.auth != null &&
            (request.auth.uid == userId ||
             request.auth.uid == resource.data.ownerId ||
             resource.data.get('guests', []) != null ||
             !resource.exists);

          // Create: only owner (check both userId context and ownerId in data)
          allow create: if request.auth != null &&
            request.auth.uid == userId &&
            request.auth.uid == request.resource.data.ownerId;

          // Update: owner can do everything, guests can update (detailed permission checks in app code)
          allow update: if request.auth != null &&
            (request.auth.uid == userId ||
             request.auth.uid == resource.data.ownerId ||
             resource.data.get('guests', []) != null);

          // Delete: only owner
          allow delete: if request.auth != null &&
            (request.auth.uid == userId &&
             request.auth.uid == resource.data.ownerId);
        }
      }
    }
  }
}