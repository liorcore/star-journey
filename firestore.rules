rules_version = '2';
service cloud.firestore {
  // Helper function to check if user is admin
  function isAdmin() {
    return request.auth != null && 
           exists(/databases/$(database)/documents/admins/$(request.auth.uid));
  }
  
  match /databases/{database}/documents {
    // Admins collection - only admins can read
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if false; // Only server-side or through admin functions
    }
    
    // Admin settings - only admins can read/write
    match /adminSettings/{settingsId} {
      allow read, write: if isAdmin();
    }
    
    // Users can only read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Admins can read all user documents
      allow read: if isAdmin();

      // Groups - only owner can modify
      match /groups/{groupId} {
        // Allow read if user is the owner (check both resource and userId context)
        allow read: if request.auth != null && 
          (request.auth.uid == userId || 
           request.auth.uid == resource.data.ownerId ||
           !resource.exists);
        allow create: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == request.resource.data.ownerId;
        allow update: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == resource.data.ownerId;
        allow delete: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == resource.data.ownerId;

        // Events - owner can do everything, guests have limited access
        match /events/{eventId} {
          // Read: owner or guest (simplified check - detailed checks in app code)
          allow read: if request.auth != null &&
            (request.auth.uid == userId ||
             request.auth.uid == resource.data.ownerId ||
             resource.data.get('guests', []) != null ||
             !resource.exists);

          // Create: only owner (check both userId context and ownerId in data)
          allow create: if request.auth != null &&
            request.auth.uid == userId &&
            request.auth.uid == request.resource.data.ownerId;

          // Update: owner can do everything, guests can update (detailed permission checks in app code)
          allow update: if request.auth != null &&
            (request.auth.uid == userId ||
             request.auth.uid == resource.data.ownerId ||
             resource.data.get('guests', []) != null);

          // Delete: only owner
          allow delete: if request.auth != null &&
            (request.auth.uid == userId &&
             request.auth.uid == resource.data.ownerId);
        }
      }
      
      // Admins can read all groups and events
      match /groups/{groupId} {
        allow read: if isAdmin();
        
        match /events/{eventId} {
          allow read: if isAdmin();
        }
      }
    }
  }
}