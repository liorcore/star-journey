rules_version = '2';
service cloud.firestore {
  // Helper function to check if user is admin
  function isAdmin() {
    return request.auth != null && 
           exists(/databases/(default)/documents/admins/$(request.auth.uid));
  }
  
  match /databases/{database}/documents {
    // Admins collection
    // Allow users to read their own admin document (to check if they are admin)
    // This is safe because users can only see if their own document exists
    // IMPORTANT: Must allow read without isAdmin() check to avoid circular dependency
    match /admins/{adminId} {
      // Allow read if user is reading their own document (needed for isAdmin() to work)
      allow read: if request.auth != null && request.auth.uid == adminId;
      // Also allow admins to read other admin documents
      allow read: if isAdmin();
      allow write: if false; // Only server-side or through admin functions
    }
    
    // Admin settings - only admins can read/write
    match /adminSettings/{settingsId} {
      allow read, write: if isAdmin();
    }
    
    // Users can only read/write their own user document
    // Admins can read all user documents (including collection queries)
    match /users/{userId} {
      // Allow read if user is the owner OR if admin
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      // Allow write only if user is the owner
      allow write: if request.auth != null && request.auth.uid == userId;

      // Groups - only owner can modify, admins can read all
      match /groups/{groupId} {
        // Allow read if user is the owner or admin (check both resource and userId context)
        allow read: if request.auth != null && 
          (request.auth.uid == userId || 
           !resource.exists ||
           request.auth.uid == resource.data.ownerId ||
           isAdmin());
        allow create: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == request.resource.data.ownerId;
        allow update: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == resource.data.ownerId;
        allow delete: if request.auth != null && 
          request.auth.uid == userId && 
          request.auth.uid == resource.data.ownerId;

        // Events - owner can do everything, guests have limited access, admins can read all
        match /events/{eventId} {
          // Read: owner or guest or admin (simplified check - detailed checks in app code)
          allow read: if request.auth != null &&
            (request.auth.uid == userId ||
             !resource.exists ||
             request.auth.uid == resource.data.ownerId ||
             request.auth.uid in resource.data.get('guests', []) ||
             isAdmin());

          // Create: only owner (check both userId context and ownerId in data)
          allow create: if request.auth != null &&
            request.auth.uid == userId &&
            request.auth.uid == request.resource.data.ownerId;

          // Update: owner can do everything, guests can update (detailed permission checks in app code)
          allow update: if request.auth != null &&
            (request.auth.uid == userId ||
             request.auth.uid == resource.data.ownerId ||
             request.auth.uid in resource.data.get('guests', []));

          // Delete: only owner
          allow delete: if request.auth != null &&
            (request.auth.uid == userId &&
             request.auth.uid == resource.data.ownerId);
        }
      }
      
    }
  }
}